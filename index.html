<!DOCTYPE html>
<html lang="ko">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width">
		<title>Project IAM</title>
		<!-- <link rel="shortcut icon" type="image/x-icon" href="img/favicon.ico"> -->

		<!-- css -->
		<link rel="stylesheet" href="resource/css/main.css">
		<link rel="stylesheet" href="resource/css/sub.css">
		<link rel="stylesheet" href="resource/css/reset.css">
		<!-- //css -->

		<!-- script -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
		<!-- //script -->
	</head>
	<body>
		<div id="wrapper">
			<div class="main_visual_wrap" style="background: #f9f9f9;">
				<div class="main_visual_box">
					<h1>누구시조</h1>
					<p>Java 6기 21조</p>
				</div>
			</div>
			<div class="team_info_box wrap">
				<strong>누구시조 <br>소개</strong>
				<p>정기회의 회기는 100일을, 임시회의 회기는 30일을 초과할 수 없다. 누구든지 체포 또는 구속을 당한 때에는 즉시 변호인의 조력을 받을 권리를 가진다. 다만, 형사피고인이 스스로 변호인을 구할 수 없을 때에는 법률이 정하는 바에 의하여 국가가 변호인을 붙인다.
					대통령은 국회에 출석하여 발언하거나 서한으로 의견을 표시할 수 있다. 정부는 예산에 변경을 가할 필요가 있을 때에는 추가경정예산안을 편성하여 국회에 제출할 수 있다.			
					국회의원이 회기전에 체포 또는 구금된 때에는 현행범인이 아닌 한 국회의 요구가 있으면 회기중 석방된다. 모든 국민은 고문을 받지 아니하며, 형사상 자기에게 불리한 진술을 강요당하지 아니한다.
					국회는 헌법개정안이 공고된 날로부터 60일 이내에 의결하여야 하며, 국회의 의결은 재적의원 3분의 2 이상의 찬성을 얻어야 한다. 헌법재판소는 법률에 저촉되지 아니하는 범위안에서 심판에 관한 절차, 내부규율과 사무처리에 관한 규칙을 제정할 수 있다.</p>
			</div>
			<div class="team_memb_box wrap">
				<ul>
					<li><a href="#none" id="tiyu"><img src="resource/img/tiyu.jpg"></a></li>
					<li><a href="#none" id="ekyun"><img src="resource/img/ekyun.jpg"></a></li>
					<li><a href="#none" id="jywon"><img src="resource/img/jywon.jpg"></a></li>
					<li><a href="#none"><img src="resource/img/profile.jpg"></a></li>
					<li><a href="#none"><img src="resource/img/profile.jpg"></a></li>
				</ul>
				<!-- 팝업 -->
				<div class="popup_wrap">
					<div class="popup_box">
						<div class="top"><a href="#none" class="popupClose">팝업 닫기</a></div>
						<div class="img"><img src="resource/img/profile.jpg" alt="" id="profileImage"></div>
						<div class="text">
							<strong class="name" id="name">유태이</strong>
							<div class="infoList">
								<ul class="textList">
									<li><strong>생년월일</strong><em id="birth"></em></li>
									<li><strong>MBTI</strong><em id="mbti"></em></li>
									<li><strong>소개</strong><em id="comment"></em></li>
									<li><strong>Github</strong><a href="#none" id="github"></a></li>
									<li><strong>Blog</strong><a href="#none" id="blog"></a></li>
								</ul>
								<ul class="editList">
									<li><strong>생년월일</strong><input type="text" name="inputBirth" id="inputBirth"></li>
									<li><strong>MBTI</strong><input type="text" name="inputMbti" id="inputMbti"></li>
									<li><strong>소개</strong><input type="text" name="inputComment" id="inputComment"></li>
									<li><strong>Github</strong><input type="text" name="inputGithub" id="inputGithub"></li>
									<li><strong>Blog</strong><input type="text" name="inputBlog" id="inputBlog"></li>
								</ul>
							</div>
						</div>
						<div class="btn_box">
							<a href="#none" class="editBtn" id="editBtn">수정하기</a>
							<a href="#none" class="editBtn comp" id="editCompBtn">수정완료</a>
							<a href="#none" class="popupClose">닫기</a>
						</div>
					</div>
				</div>
				<!-- //팝업 -->
			</div>
			<div class="guest_book_wrap">
				<div class="guest_book_box wrap">
					<div class="input_comment_box">
						<textarea id="comment" placeholder="텍스트를 입력해주세요."></textarea>
						<button type="button" id="commentBtn">등록</button>
					</div>
					<div class="comment_list_box">
						<ul id="commentList"></ul>
					</div>
				</div>
			</div>
		</div>
        <script type="module">
			// Firebase SDK 라이브러리 가져오기
			import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
			import { getFirestore } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
			import { doc, getDoc, collection, addDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
			import { getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

			// Firebase 구성 정보 설정
			const firebaseConfig = {
				apiKey: "AIzaSyAzRZRrFoHhcGrmR78yNNRN2AXwLLm0CnU",
				authDomain: "sparta-f1798.firebaseapp.com",
				projectId: "sparta-f1798",
				storageBucket: "sparta-f1798.appspot.com",
				messagingSenderId: "340506378648",
				appId: "1:340506378648:web:0eddeef3ff3c5d9e5eabed",
				measurementId: "G-JLXDX6XFJC"
			};

			// Firebase 인스턴스 초기화
			const app = initializeApp(firebaseConfig);
			const db = getFirestore(app);


			//방명록 데이터 등록
			$('#commentBtn').click(async function(){
				let comment = $('textarea#comment').val();
				let commentTrim = comment.trim(); //문자열 앞뒤 공백을 모두 제거
                if ( commentTrim === ''){
                    //공백만 있을 때
                    alert('텍스트를 입력해주세요.');
                } else {
                    try {
                        const doc = await addDoc(collection(db, 'guestComment'), {
                            'comment': comment,
                        });
                        alert('등록되었습니다.');
                        window.location.reload(); //페이지 새로고침
                    } catch (e) {
                        console.error(e);
                    }
                }
			});

			//방명록 댓글 생성
			$('#commentList').empty(); //empty는 비워주기
			//const queryComment = await db.collection('guestComment').get();
			const queryComment = await getDocs(collection(db, 'guestComment'));

			queryComment.forEach((doc) => {
				let comment = doc.data().comment;
                let docId = doc.id; //데이터 아이디 추출
                
                let commentTrim = comment.trim(); //문자열 앞뒤의 공백을 모두 제거

				let tempHtml = `<li id="${docId}">
									<p class="comment">${comment}</p>
									<button class="delBtn">삭제</button>
								</li>`

                if (commentTrim = null || commentTrim == '') {
                    //공백만 있을 때
                    console.log("여기는 빈칸일때", commentTrim);
                } else {
                    $('#commentList').append(tempHtml);
                }
			});

			//페이지 로드 시 모든 삭제 버튼에 이벤트 리스너 추가
			$('.delBtn').each(function(){
				addDelete($(this));
			});

			//삭제 버튼 이벤트 리스너
			function addDelete(node) {
				//삭제 버튼에 클릭 이벤트 리스너 등록
				node.off().on('click', async function(e){
					//if(window.confirm('삭제하시겠습니까?')) return;

					//삭제 확인 여부
					const confirmed = window.confirm('삭제하시겠습니까?');

					//확인이 아닌 경우, 함수를 종료 .. ! 느낌표 꼭 붙여줘야 함
					if(!confirmed) return;

					const commentEl = e.currentTarget.closest('li');
					const docId = commentEl.id; //li 요소의 삭제할 문서의 id를 가져옴

					//Firestore에서 댓글 문서 삭제
					try {
						await deleteDoc(doc(db, 'guestComment', docId));
						alert('삭제 완료');
						commentEl.remove();
					} catch (error) {
						console.error('Error removing document: ', error);
						alert('댓글 삭제에 실패했습니다.')
					}
				});
			}

			// 전역 변수 선언
			let dbIdName = "";
			
			//프로필 팝업 열기
			$('.team_memb_box > ul li a').click(async function (){
				//버튼 아이디 값
				dbIdName = $(this).attr('id');
				console.log('dbIdName:', dbIdName); // 디버깅용 콘솔 출력

				//팝업 열기
				$('.popup_wrap').addClass ('active');

				//프로필 이미지 파일명 변경
				const profileImage = document.getElementById('profileImage');
				profileImage.src = `resource/img/${dbIdName}.jpg`;

				const info = await getDoc(doc(db, 'memInfo', dbIdName));
				const row = info.data();

				const name = document.getElementById('name');
				const birth = document.getElementById('birth');
				const mbti = document.getElementById('mbti');
				const comment = document.getElementById('comment');
				const githubUrl = document.getElementById('github');
				const blog = document.getElementById('blog');

				name.innerHTML = `${row.name}`;
				birth.innerHTML = `${row.birth}`;
				mbti.innerHTML = `${row.mbti}`;
				comment.innerHTML = `${row.comment}`;
				githubUrl.innerHTML = `${row.githubUrl}`;
				blog.innerHTML = `${row.blog}`;

				//input value에 데이터 추가
				$('#inputBirth').val(birth.textContent);
				$('#inputMbti').val(mbti.textContent);
				$('#inputComment').val(comment.textContent);
				$('#inputGithub').val(github.textContent);
			});

			//프로필 수정하기 버튼 클릭 시
			$('#editBtn').click(async function(){
				$('.infoList .textList').hide();
				$('.infoList .editList').show();

				$('.btn_box a.editBtn').hide();
				$('.btn_box a.comp').show();
			});

			//수정 완료 버튼 클릭 시
			$('#editCompBtn').click(async function(){
				const updatedData = {
					birth: $('#inputBirth').val(),
					mbti: $('#inputMbti').val(),
					comment: $('#inputComment').val(),
					githubUrl: $('#inputGithub').val(),
					blog: $('#inputBlog').val()
				}

				const docRef = doc(db, 'memInfo', dbIdName);
				console.log('docRef:', docRef.path); // 디버깅용 콘솔 출력

				await updateDoc(docRef, updatedData);

				//업데이트가 완료되면 화면에도 반영할 수 있도록 다시 읽어오기
				const updatedInfo = await getDoc(docRef);
				const updatedRow = updatedInfo.data();

				const birth = document.getElementById('birth');
				const mbti = document.getElementById('mbti');
				const comment = document.getElementById('comment');
				const githubUrl = document.getElementById('github');
				const blog = document.getElementById('blog');

				birth.innerHTML = `${updatedRow.birth}`;
				mbti.innerHTML = `${updatedRow.mbti}`;
				comment.innerHTML = `${updatedRow.comment}`;
				githubUrl.innerHTML = `${updatedRow.githubUrl}`;
				blog.innerHTML = `${updatedRow.blog}`;
				

				$('.infoList .textList').show();
				$('.infoList .editList').hide();

				$('.btn_box a.editBtn').show();
				$('.btn_box a.comp').hide();
			});

			//프로필 팝업 닫기
			$('.popupClose').click(function (){
				$('.popup_wrap').removeClass('active');

				$('.infoList .textList').show();
				$('.infoList .editList').hide();

				$('.btn_box a.editBtn').show();
				$('.btn_box a.comp').hide();
			});
		</script>
	</body>
</html>